version: '3'
services:
  app:
    build:
      version: '3.8'

      services:
        db:
          version: '3.8'

          services:
            db:
              image: postgres:15
              container_name: postgres_db
              restart: always
              environment:
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: '1111'
                POSTGRES_DB: epdb
              ports:
                # mapped to 5433 on the host to avoid conflicts with local Postgres; change to '5432:5432' if you want host 5432
                - '5433:5432'
              volumes:
                - postgres_data:/var/lib/postgresql/data

            app:
              build:
                context: .
                dockerfile: Dockerfile
              container_name: nest_app
              restart: always
              ports:
                - '3000:3000'
              environment:
                DB_HOST: db
                DB_PORT: '5432'
                DB_USER: postgres
                DB_PASSWORD: '1111'
                DB_NAME: epdb
              depends_on:
                - db

          volumes:
            postgres_data:
